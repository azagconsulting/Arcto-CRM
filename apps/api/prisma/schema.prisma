generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(191)
  slug        String   @unique @db.VarChar(191)
  description String?  @db.VarChar(255)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users                User[]
  leads                Lead[]
  leadUpdates          LeadUpdate[]
  leadWorkflowSettings LeadWorkflowSetting[]
  customers            Customer[]
  customerMessages     CustomerMessage[]
  tenantSettings       TenantSetting[]
  tasks                Task[]
  trackingSessions     TrackingSession[]
  trackingEvents       TrackingEvent[]
}

enum UserRole {
  ADMIN
  COORDINATOR
  AGENT
  VIEWER
}

enum LeadStatus {
  NEW
  QUALIFIED
  IN_PROGRESS
  WON
  LOST
  ARCHIVED
}

enum LeadPriority {
  LOW
  MEDIUM
  HIGH
}

enum CustomerSegment {
  ENTERPRISE
  SCALE
  TRIAL
}

enum CustomerHealth {
  GOOD
  ATTENTION
  RISK
}

enum CustomerActivityStatus {
  SCHEDULED
  DONE
  WAITING
}

enum CustomerMessageDirection {
  INBOUND
  OUTBOUND
}

enum CustomerMessageStatus {
  DRAFT
  QUEUED
  SENDING
  SENT
  FAILED
}

enum MessageCategory {
  ANGEBOT
  KRITISCH
  KUENDIGUNG
  WERBUNG
  SONSTIGES
}

enum TaskStatus {
  BACKLOG
  IN_PROGRESS
  REVIEW
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum TaskBoard {
  TEAM
  MY
}

enum TrackingEventType {
  PAGE_VIEW
  PAGE_EXIT
  CLICK
}

enum TrafficSource {
  DIRECT
  ORGANIC
  REFERRAL
}

model User {
  id           String     @id @default(uuid())
  tenantId     String
  email        String     @unique @db.VarChar(191)
  passwordHash String     @db.VarChar(255)
  firstName    String?    @db.VarChar(120)
  lastName     String?    @db.VarChar(120)
  avatarUrl    String?    @db.VarChar(512)
  jobTitle     String?    @db.VarChar(191)
  phone        String?    @db.VarChar(64)
  location     String?    @db.VarChar(191)
  headline     String?    @db.VarChar(191)
  bio          String?    @db.Text
  pronouns     String?    @db.VarChar(64)
  linkedinUrl  String?    @db.VarChar(255)
  twitterUrl   String?    @db.VarChar(255)
  calendlyUrl  String?    @db.VarChar(255)
  role         UserRole   @default(COORDINATOR)
  lastLoginAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignedLeads    Lead[]               @relation("LeadAssignee")
  leadUpdates      LeadUpdate[]
  workflowSettings LeadWorkflowSetting[] @relation("LeadWorkflowSettingsAutoAssign")
  blogPosts        BlogPost[]
  tasksAssigned    Task[]      @relation("TaskAssignee")
  tasksCreated     Task[]      @relation("TaskCreator")

  @@index([tenantId])
}

model Lead {
  id            String       @id @default(uuid())
  tenantId      String
  fullName      String       @db.VarChar(191)
  email         String       @db.VarChar(191)
  company       String?      @db.VarChar(191)
  phone         String?      @db.VarChar(64)
  message       String?      @db.Text
  source        String       @default("web") @db.VarChar(64)
  status        LeadStatus   @default(NEW)
  priority      LeadPriority @default(MEDIUM)
  routingLabel  String?      @db.VarChar(120)
  assignedToId  String?
  processedAt   DateTime?
  archivedAt    DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignedTo User?       @relation("LeadAssignee", fields: [assignedToId], references: [id])
  updates     LeadUpdate[]
  messages    CustomerMessage[]

  @@index([status])
  @@index([assignedToId])
  @@index([createdAt])
  @@index([tenantId])
}

model Task {
  id          String       @id @default(uuid())
  tenantId    String
  title       String       @db.VarChar(255)
  description String?      @db.Text
  status      TaskStatus   @default(BACKLOG)
  priority    TaskPriority @default(MEDIUM)
  board       TaskBoard    @default(TEAM)
  assigneeId  String?
  creatorId   String?
  dueDate     DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignee  User?  @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator   User?  @relation("TaskCreator", fields: [creatorId], references: [id])

  @@index([tenantId, board, status])
  @@index([assigneeId])
  @@index([creatorId])
  @@index([createdAt])
}

model LeadUpdate {
  id        String     @id @default(uuid())
  tenantId  String
  leadId    String
  userId    String?
  status    LeadStatus
  note      String?    @db.VarChar(255)
  createdAt DateTime   @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  lead Lead @relation(fields: [leadId], references: [id])
  user User? @relation(fields: [userId], references: [id])

  @@index([leadId, createdAt])
  @@index([tenantId])
}

model LeadWorkflowSetting {
  id                    String   @id @default(uuid())
  tenantId              String
  autoAssignUserId      String?
  notifyEmail           String?  @db.VarChar(191)
  autoResponderEnabled  Boolean  @default(false)
  autoResponderMessage  String?  @db.Text
  routingHeadline       String?  @db.VarChar(191)
  routingDescription    String?  @db.VarChar(255)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  autoAssignUser User? @relation("LeadWorkflowSettingsAutoAssign", fields: [autoAssignUserId], references: [id])

  @@index([tenantId])
}

model BlogPost {
  id          String   @id @default(uuid())
  title       String   @db.VarChar(191)
  slug        String   @unique @db.VarChar(191)
  excerpt     String?  @db.VarChar(320)
  content     String   @db.Text
  coverImage  String?  @db.VarChar(512)
  featured    Boolean  @default(false)
  published   Boolean  @default(false)
  publishedAt DateTime?
  authorId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  author User? @relation(fields: [authorId], references: [id])

  @@index([authorId])
  @@index([published, publishedAt])
}


model Customer {
  id               String              @id @default(uuid())
  tenantId         String
  name             String              @db.VarChar(191)
  segment          CustomerSegment     @default(SCALE)
  ownerName        String?             @db.VarChar(191)
  region           String?             @db.VarChar(120)
  health           CustomerHealth      @default(GOOD)
  mrrCents         Int                 @default(0)
  lastContactAt    DateTime?
  nextStep         String?             @db.VarChar(191)
  nextStepDueAt    DateTime?
  decisionStage    String?             @db.VarChar(120)
  preferredChannel String?             @db.VarChar(64)
  tags             Json?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contacts   CustomerContact[]
  activities CustomerActivity[]
  messages   CustomerMessage[]

  @@index([tenantId])
}

model CustomerContact {
  id          String   @id @default(uuid())
  customerId  String
  name        String   @db.VarChar(191)
  role        String?  @db.VarChar(120)
  channel     String?  @db.VarChar(64)
  email       String?  @db.VarChar(191)
  phone       String?  @db.VarChar(64)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  messages CustomerMessage[]

  @@index([customerId])
}

model CustomerActivity {
  id           String                 @id @default(uuid())
  customerId   String
  title        String                 @db.VarChar(191)
  detail       String?                @db.VarChar(255)
  channel      String?                @db.VarChar(64)
  status       CustomerActivityStatus @default(SCHEDULED)
  scheduledAt  DateTime?
  completedAt  DateTime?
  createdAt    DateTime               @default(now())

  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId, scheduledAt])
}

model CustomerMessage {
  id          String                  @id @default(uuid())
  tenantId    String
  customerId  String?
  leadId      String?
  contactId   String?
  direction   CustomerMessageDirection
  status      CustomerMessageStatus    @default(SENT)
  subject     String?                  @db.VarChar(191)
  preview     String?                  @db.VarChar(255)
  body        String                   @db.Text
  fromEmail   String?                  @db.VarChar(191)
  toEmail     String?                  @db.VarChar(191)
  externalId  String?                  @db.VarChar(191)
  attachments Json?
  sentAt      DateTime?
  receivedAt  DateTime?
  readAt      DateTime?
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt

  // AI analysis fields
  category    MessageCategory?
  sentiment   String?                 @db.VarChar(64)
  urgency     String?                 @db.VarChar(64)
  summary     String?                 @db.VarChar(512)
  analyzedAt  DateTime?

  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer Customer?       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  lead     Lead?           @relation(fields: [leadId], references: [id], onDelete: Cascade)
  contact  CustomerContact? @relation(fields: [contactId], references: [id])

  @@index([customerId, createdAt])
  @@index([contactId])
  @@index([leadId, createdAt])
  @@index([analyzedAt])
  @@index([tenantId])
  @@index([tenantId, direction, createdAt])
}

model TenantSetting {
  id        String   @id @default(uuid())
  tenantId  String
  key       String   @db.VarChar(191)
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId])
}

model TrackingSession {
  id           String         @id @default(uuid())
  tenantId     String
  sessionKey   String         @db.VarChar(191)
  trafficSource TrafficSource @default(DIRECT)
  referrer     String?        @db.VarChar(512)
  utmSource    String?        @db.VarChar(120)
  utmMedium    String?        @db.VarChar(120)
  firstPage    String?        @db.VarChar(255)
  startedAt    DateTime       @default(now())
  lastSeenAt   DateTime       @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  events TrackingEvent[]

  @@unique([tenantId, sessionKey])
  @@index([tenantId, trafficSource])
  @@index([tenantId, lastSeenAt])
}

model TrackingEvent {
  id         String            @id @default(uuid())
  tenantId   String
  sessionId  String
  type       TrackingEventType
  path       String            @db.VarChar(255)
  label      String?           @db.VarChar(255)
  durationMs Int?
  createdAt  DateTime          @default(now())

  tenant  Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  session TrackingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([tenantId, path, type, createdAt])
  @@index([sessionId])
}
